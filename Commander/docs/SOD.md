# SOD (Service-Oriented Design) ドキュメント

## 1. ハイレベルアーキテクチャ

このアプリケーションは、Reactで構築されたターン制ストラテジーゲームです。コンポーネントベースのアーキテクチャに従っており、ゲームロジック、UIレンダリング、データ管理の間で関心事が明確に分離されています。

- **`App.tsx`**: アプリケーションのメインエントリーポイント。ゲーム全体の状態と画面間のナビゲーションを管理します。
- **`screens`**: アプリケーションの各画面（例：`TitleScreen`、`BattleScreen`）のトップレベルコンポーネントを格納します。
- **`components`**: 異なる画面で再利用されるUIコンポーネント。
- **`hooks`**: コアゲームロジック（`useGameLogic`）など、複雑なロジックをカプセル化するカスタムReactフック。
- **`types`**: アプリケーションで使用されるすべてのデータ構造のTypeScript型定義。
- **`utils`**: マップ操作や座標変換などの共通タスクのためのユーティリティ関数。
- **`data`**: マップファイルやユニット定義などの静的データを格納します。

## 2. サービス分割

### 2.1. ゲームロジックサービス (`useGameLogic.ts`)

このサービスはアプリケーションの中核であり、ゲームの状態管理とゲームルールの強制を担当します。

**責務:**

- **ゲーム状態管理:** ゲームのターン、アクティブなチーム、ボードレイアウト、ユニット、およびゲームステータス（プレイ中、ゲームオーバー）を管理します。
- **ゲームアクション:** ユニットの選択、移動、攻撃、ターン終了など、すべてのゲームアクションを処理します。
- **ルール適用:** 移動範囲、攻撃範囲、勝敗条件などのゲームルールを適用します。
- **履歴管理:** アクションの取り消しを可能にするために、ゲームの状態履歴を保持します。

**主要な関数:**

- `loadGame(mapData)`: マップデータファイルからゲームの状態を初期化します。
- `handleHexClick(coord)`: ゲームボード上のユーザーのクリックを処理します。
- `handleEndTurn()`: 現在のターンを終了し、次のプレイヤーに切り替えます。
- `handleAction(action)`: 「待機」や「占領」などの特別なアクションを処理します。
- `handleAttack(attacker, defender)`: 2つのユニット間の戦闘を解決します。

### 2.2. UIサービス (`components/` および `screens/`)

このサービスは、アプリケーションのユーザーインターフェースのレンダリングを担当します。

**責務:**

- **画面レンダリング:** 現在のゲーム状態に基づいて適切な画面をレンダリングします。
- **ゲームボードレンダリング:** タイルやユニットを含む六角形のゲームボードをレンダリングします。
- **UI要素:** ボタン、メニュー、情報パネルなどのUI要素をレンダリングします。
- **ユーザー入力:** ユーザー入力をキャプチャし、ゲームロジックサービスに転送します。

**主要なコンポーネント:**

- **`App.tsx`**: 画面遷移を管理するルートコンポーネント。
- **`BattleScreen.tsx`**: 戦闘が行われるメインのゲーム画面。
- **`GameBoard.tsx`**: 六角形のゲームボードをレンダリングするコンポーネント。
- **`Hexagon.tsx`**: 個々の六角形タイルをレンダリングするコンポーネント。
- **`InformationPanel.tsx`**: 選択されたユニットやタイルに関する情報を表示するコンポーネント。

### 2.3. マップサービス (`utils/map.ts`)

このサービスは、ゲームマップを操作するためのユーティリティ関数を提供します。

**責務:**

- **マップ読み込み:** JSONファイルからマップデータを読み込みます。
- **座標操作:** 異なる座標系（例：軸座標からピクセル座標）間で変換する関数を提供します。
- **経路探索:** ユニットが到達可能なタイルを計算し、2点間の最短経路を見つけます。

**主要な関数:**

- `loadMapFromJSON(mapData)`: マップデータを読み込み、ボードレイアウトとユニットを初期化します。
- `calculateReachableTiles(...)`: ユニットが移動できるタイルを計算します。
- `findPath(...)`: ユニットの目的地までの最短経路を見つけます。
- `coordToString(coord)`: 座標オブジェクトをマップキーとして使用するために文字列に変換します。

## 3. データモデル (`types/index.ts`)

このアプリケーションは、ゲームデータを表現するために、明確に定義されたTypeScriptインターフェースのセットを使用します。

- **`GameState`**: ゲーム全体の総合的な状態を表します。
- **`Unit`**: ゲームボード上の個々のユニットを表します。
- **`Tile`**: ゲームボード上の個々のタイルを表します。
- **`GameMap`**: マップシナリオを表します。
- **`BattleReport`**: 戦闘の結果を表します。

## 4. ユーザーフロー

1.  **タイトル画面:** ユーザーはアプリケーションを起動し、タイトル画面を見ます。
2.  **ホーム画面:** ユーザーはホーム画面に移動し、新しいゲームを開始するか、保存されたゲームをロードするかを選択できます。
3.  **シナリオ選択画面:** ユーザーはプレイするシナリオを選択します。
4.  **戦闘準備画面:** ユーザーは戦闘を開始する前に、マップと自軍ユニットを確認できます。
5.  **戦闘画面:** ユーザーがゲームをプレイするメインのゲーム画面。
6.  **リザルト画面:** ゲームが終了すると、勝者やその他の統計情報を表示するリザルト画面が表示されます。