## **【更新版】ゲーム仕様書：Gemini Saga - Hex Strategy**

### 1. **ゲーム概要**

このアプリケーションは、第二次世界大戦をテーマにした、ヘックス（六角形）グリッド上で進行するターン制の戦略シミュレーションゲームです。プレイヤーは「Blue」チームまたは「Red」チームを率いて、敵チームの全ユニットを殲滅することを目指します。

最大の特徴は、戦闘結果をGoogleのGemini AIを用いて物語風に生成する「戦闘レポート」機能です。

* **プラットフォーム**: Webブラウザ
* **開発言語**: TypeScript
* **UIライブラリ**: React
* **ビルドツール**: Vite

---

### 2. **ユニット特性**

ゲームには4種類のユニットが登場し、それぞれ異なるステータス（能力値）と特性を持ちます。

| ユニット種別 | 最大HP | 攻撃力 | 防御力 | 移動力 | 攻撃範囲 | 反撃 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **Infantry (歩兵)** | 10 | 4 | 2 | 3 | 1 | 可能 |
| **Tank (戦車)** | 20 | 7 | 5 | 4 | 1 | 可能 |
| **ArmoredCar (装甲車)** | 15 | 5 | 4 | 6 | 1 | 可能 |
| **Artillery (砲兵)** | 12 | 8 | 3 | 1 | 2-5 | 不可 |

* **攻撃範囲**: ユニットが攻撃できる距離（ヘックス数）。砲兵は隣接する敵を攻撃できず、2〜5マス離れた敵を攻撃します。
* **反撃**: 攻撃された際に反撃できるかどうか。砲兵は反撃できません。

---

### 3. **地形特性**

マップは複数の地形で構成されており、それぞれがユニットの戦闘や移動に影響を与えます。

| 地形種別 | 防御ボーナス | 攻撃ボーナス | 移動コスト |
| :--- | :--- | :--- | :--- |
| **Plains (平原)** | 0 | 0 | 全ユニット: 1 |
| **Forest (森林)** | +2 | 0 | 歩兵/砲兵: 1, 戦車/装甲車: 2 |
| **Mountain (山岳)**| +3 | +2 | 歩兵: 2, その他: 移動不可 |
| **River (川)** | -2 | -1 | 歩兵: 2, その他: 移動不可 |
| **Road (道路)** | -1 | 0 | 全ユニット: 1 |
| **Bridge (橋)** | -1 | 0 | 全ユニット: 1 |
| **City (都市)** | +3 | +1 | 全ユニット: 1 |
| **Mud (泥沼)** | -1 | 0 | 歩兵: 2, 戦車: 3, 装甲車: 4, 砲兵: 1 |

* **防御ボーナス**: その地形にいるユニットの防御力に加算されます。
* **攻撃ボーナス**: その地形にいるユニットの攻撃力に加算されます。
* **移動コスト**: その地形を1マス移動するために必要な移動力。コストがユニットの移動力を超える場合や「移動不可」の場合は、その地形に進入できません。

---

### 4. **プログラム仕様 (ファイル別機能一覧)**

このプログラムはコンポーネントベースで設計されており、各ファイルが特定の役割を担っています。

| ファイルパス | 主な役割と情報 |
| :--- | :--- |
| **`App.tsx`** | 🧠 **アプリケーションの心臓部**。ゲーム全体のロジックと状態（ターン、アクティブチーム、ユニット、ゲーム状態など）を管理します。ユニットの選択、移動、攻撃などの主要なゲームイベントのハンドリングを行います。 |
| **`constants.ts`** | 🔢 **ゲーム内定数**。ユニットのステータス、地形の効果、ユニットの初期配置など、ゲームの根幹をなす不変のデータが定義されています。 |
| **`types.ts`** | 📝 **TypeScriptの型定義**。`Unit`（ユニット）、`Tile`（タイル）、`Team`（チーム）など、アプリケーション全体で使用されるデータ構造を定義し、コードの安全性を保証します。 |
| **`utils/map.ts`** | 🗺️📐 **マップ関連の計算処理**。ランダムなマップレイアウトの生成、ユニットの移動可能範囲の計算（ダイクストラ法に似たアルゴリズム）、座標計算などの関数が含まれます。 |
| **`services/battleReport.ts`** | 🤖 **戦闘レポート生成**。戦闘情報を基に、物語風のテキストを生成するサービスです。Gemini APIとの連携を担う部分です。 |
| **`components/GameBoard.tsx`** | 🗺️ **ゲーム盤の描画**。ヘックスタイル、ユニット、移動可能範囲、攻撃可能範囲などをSVGで描画するメインコンポーネントです。 |
| **`components/InfoPanel.tsx`** | ℹ️ **情報パネル**。選択したユニットやマウスオーバーしたタイルの詳細情報を表示します。ゲームオーバー時の結果表示やリスタート機能も提供します。 |
| **`components/Header.tsx`** | 🔝 **ヘッダー**。現在のターン数、アクティブなチーム、各チームの残りユニット数を表示し、「ターン終了」ボタンを提供します。 |
| **`components/BattleReportModal.tsx`** | 💥 **戦闘レポートモーダル**。戦闘結果をドラマチックに表示するためのUIコンポーネントです。 |
| **`components/Hexagon.tsx`** | ⬢ **ヘックスタイル**。個々の六角形タイルを描画し、地形に応じた色や移動可能範囲のハイライトを表現します。 |
| **`components/Icons.tsx`** | 🛡️ **ユニットアイコン**。ユニットの種類（歩兵、戦車など）を視覚的に表現するSVGアイコンを描画します。 |
| **`index.html` & `index.tsx`** | 🚀 **起動ファイル**。アプリケーションのエントリーポイント（起動点）です。HTMLの骨格を定義し、ReactアプリケーションをDOMに描画します。 |
| **`README.md`** | 📖 **説明書**。プロジェクトの概要と、ローカル環境でアプリケーションを実行するための手順が記載されています。 |


承知いたしました。提供されたソースコードと仕様書に基づき、機能定義書を作成します。

---

## **機能定義書：Gemini Saga - Hex Strategy**

このドキュメントは、戦略シミュレーションゲーム「Gemini Saga - Hex Strategy」の主要な機能、コンポーネント、およびデータ構造を定義します。

### **1. ゲームの基本構造 (App.tsx)**

アプリケーション全体のロジックと状態管理は、`App.tsx` コンポーネントが担います。

| 状態 (State) | 型 (Type) | 説明 |
| :--- | :--- | :--- |
| `gameState` | `GameState` | 現在のゲームの状態（'playing' または 'gameOver'）。 |
| `turn` | `number` | 現在のターン数。 |
| `activeTeam` | `Team` | 現在行動可能なチーム（'Blue' または 'Red'）。 |
| `boardLayout` | `BoardLayout` | マップの地形情報を保持するMapオブジェクト。 |
| `units` | `Unit[]` | 全てのユニットの情報を保持する配列。 |
| `selectedUnitId` | `string | null` | 選択されているユニットのID。 |
| `hoveredHex` | `Coordinate | null` | マウスカーソルが乗っているヘックスの座標。 |
| `battleReport` | `BattleReport | null` | 戦闘レポートの情報を保持するオブジェクト。 |
| `history` | `GameStateSnapshot[]` | アンドゥ機能のためにゲーム状態のスナップショットを保持します。 |

| 主要な関数 | 説明 |
| :--- | :--- |
| `initializeGame()` | ゲームの初期化処理。ボードレイアウトとユニットを生成・配置します。 |
| `handleEndTurn()` | ターン終了処理。アクティブチームを切り替え、天候を更新し、ユニットの状態をリセットします。 |
| `checkWinCondition()` | 勝利条件の判定。どちらかのチームのユニットが全滅したかを判定します。 |
| `handleAttack()` | 攻撃処理。攻撃計算を行い、戦闘レポートを生成し、ユニットの状態を更新します。 |
| `handleHexClick()` | ヘックスタイルクリック時の処理。ユニットの選択、移動、攻撃などのアクションを実行します。 |
| `handleAction()` | 「待機」や「アンドゥ」などのアクションを処理します。 |

---

### **2. 定数と型定義**

#### **2.1. ゲーム内定数 (constants.ts)**

ゲームのバランスを定義する不変のデータです。

* **`MAP_MIN_Q`, `MAP_MAX_Q`, `MAP_MIN_R`, `MAP_MAX_R`**: マップの広さを定義します。
* **`HEX_SIZE`**: ヘックスの描画サイズを定義します。
* **`UNIT_STATS`**: `Infantry`, `Tank`, `ArmoredCar`, `Artillery`, `AntiTank` の各ユニットのステータス（最大HP、攻撃力、防御力、移動力など）を定義します。
* **`TERRAIN_STATS`**: `Plains`, `Forest`, `Mountain` など、各々の地形が戦闘や移動に与える影響（ボーナス、移動コスト）を定義します。
* **`INITIAL_UNIT_POSITIONS`**: 各チームのユニットの初期配置を定義します。
* **`TEAM_COLORS`**: 各チームのテーマカラーを定義します。

#### **2.2. 型定義 (types.ts)**

TypeScriptによる静的型付けのための定義です。

* **`Team`**: `'Blue' | 'Red'`
* **`UnitType`**: `'Infantry' | 'Tank' | 'ArmoredCar' | 'Artillery' | 'AntiTank'`
* **`TerrainType`**: `'Plains' | 'Forest' | ...`
* **`Unit`**: ユニットの全情報（ID, HP, 攻撃力, 座標など）を含むインターフェース。
* **`Tile`**: ヘックスタイルの情報（座標、地形）を含むインターフェース。
* **`BattleReport`**: 戦闘レポートの情報（攻撃側、防御側、ダメージ、レポート本文）を含むインターフェース。
* **`GameStateSnapshot`**: アンドゥ機能のためのゲーム状態のスナップショットの型定義です。

---

### **3. コアロジック**

#### **3.1. マップ関連処理 (utils/map.ts)**

| 関数名 | 説明 |
| :--- | :--- |
| `generateBoardLayout()` | ランダムなマップを生成します。平原をベースに、都市、川、山岳、森林などを配置します。 |
| `calculateReachableTiles()` | 選択されたユニットの移動可能範囲を計算します。敵ユニットのZOC（支配領域）を考慮し、移動コストを計算します。 |
| `getDistance()` | 2つのヘックス間の距離を計算します。 |
| `getNeighbors()` | 指定されたヘックスに隣接する全てのヘックスの座標を取得します。 |
| `axialToPixel()`, `coordToString()` | 座標系の変換や管理のためのユーティリティ関数です。 |

#### **3.2. 戦闘レポート生成 (services/battleReport.ts)**

| 関数名 | 説明 |
| :--- | :--- |
| `generateBattleReport()` | 攻撃側・防御側ユニット、地形、ダメージ情報を基に、物語風の戦闘レポートテキストを生成します。 |

---

### **4. UIコンポーネント**

#### **4.1. GameBoard.tsx**

ゲーム盤全体の描画を担当するメインコンポーネントです。

* ヘックスタイル、ユニット、移動・攻撃可能範囲の表示。
* SVGを用いて盤面を描画し、ズームやスクロール操作を可能にします。
* 天候エフェクト（雨など）の描画も行います。

#### **4.2. InfoPanel.tsx**

画面右側に表示される情報パネルです。

* 選択中のユニット、またはマウスオーバーしたタイル・ユニットの詳細情報を表示します。
* ユニットのステータス（HP、攻撃力など）や地形効果を確認できます。
* ユニットの行動（待機、アンドゥ）を選択するボタンを提供します。
* ゲーム終了時には、勝者を表示し、リスタートボタンを提供します。

#### **4.3. Header.tsx**

画面上部に表示されるヘッダーです。

* 現在のターン数、アクティブなチーム、各チームの残りユニット数を表示します。
* **「End Turn」** ボタンを提供し、クリックするとターンを終了します。

#### **4.4. BattleReportModal.tsx**

戦闘発生時に表示されるモーダルウィンドウです。

* 攻撃側と防御側のユニット情報、与えられたダメージ、そして `generateBattleReport` によって生成された物語風のレポートを表示します。

#### **4.5. Hexagon.tsx & Icons.tsx**

* **`Hexagon.tsx`**: 個々のヘックスタイルを描画します。地形に応じた色や、移動・攻撃範囲のハイライトを表現します。
* **`Icons.tsx`**: ユニットの種類を視覚的に表現するSVGアイコンを描画します。