# 🧑‍💻 機能定義書：Hex Strategy Tactics

### 1. ゲームの基本構造と状態管理 (`App.tsx`)
アプリケーションの主要な状態は`App.tsx`で管理されており、`useState`フックを用いて定義されています。

| 状態 (State) | 型 (Type) | 説明 |
| :--- | :--- | :--- |
| `gameState` | `GameState` (`'playing'` or `'gameOver'`) | ゲームの現在の状態（プレイ中かゲームオーバーか） |
| `turn` | `number` | 現在のターン数 |
| `activeTeam` | `Team` (`'Blue'` or `'Red'`) | 現在行動中のチーム |
| `boardLayout` | `BoardLayout` (`Map<string, Tile>`) | マップのヘックスタイル情報 |
| `units` | `Unit[]` | マップ上の全ユニットの配列 |
| `selectedUnitId` | `string | null` | 現在選択されているユニットのID |
| `hoveredHex` | `Coordinate | null` | マウスオーバーされているヘックスの座標 |
| `battleReport` | `BattleReport | null` | 最新の戦闘レポートデータ |
| `isLoadingAI` | `boolean` | AIが戦闘レポートを生成中かどうかのフラグ |
| `winner` | `Team | null` | ゲームオーバー時の勝利チーム |
| `weather` | `WeatherType` | 現在の天候（`'Sunny'`, `'Rain'`, `'HeavyRain'`, `'Storm'`） |
| `weatherDuration` | `number` | 現在の天候が続いているターン数 |
| `history` | `GameStateSnapshot[]` | ターンごとのゲーム状態のスナップショット（Undo機能用） |

### 2. 主要な関数/メソッド
`App.tsx`内で定義されている主要なゲームロジック関数です。

*   `initializeGame()`: ゲームの初期状態を設定し、ボードレイアウトとユニットを配置します。
*   `saveStateToHistory()`: 現在のゲーム状態を履歴に保存します（Undo機能用）。
*   `handleEndTurn()`: ターンを終了し、次のチームに手番を渡します。天候の更新とユニットの状態リセットも行います。
*   `checkWinCondition(currentUnits: Unit[])`: 現在のユニットリストに基づいて勝利条件をチェックし、ゲームオーバー状態を更新します。
*   `handleAttack(attacker: Unit, defender: Unit)`: ユニット間の戦闘処理を実行します。ダメージ計算、ユニットHPの更新、戦闘レポートの生成、反撃処理、勝利条件チェックを含みます。
*   `handleHexClick(coord: Coordinate)`: ヘックスがクリックされた際の処理を定義します。ユニットの選択、移動、攻撃の実行を制御します。
*   `handleAction(action: 'wait' | 'undo')`: 選択中のユニットに対するアクション（待機、移動の取り消し）を実行します。

### 3. 定数と型定義 (`constants.ts`, `types.ts`)

*   `constants.ts`: ゲームの基本的な定数（マップサイズ、ヘックスサイズ、ユニットの初期配置、ユニットの基本ステータス、地形のステータス、チームカラーなど）を定義します。ゲームバランス調整の主要な設定ファイルです。
*   `types.ts`: アプリケーション全体で使用されるTypeScriptの型定義（`Team`, `UnitType`, `TerrainType`, `GameState`, `Coordinate`, `Unit`, `Tile`, `BoardLayout`, `UnitStats`, `TerrainStats`, `BattleReport`, `GameStateSnapshot`など）を定義します。これにより、コードの型安全性が保証されます。

### 4. コアロジック

#### 4.1. マップ関連処理 (`utils/map.ts`)
*   `coordToString(coord: Coordinate): string`: 座標オブジェクトを文字列キーに変換します。
*   `stringToCoord(key: string): Coordinate`: 文字列キーを座標オブジェクトに変換します。
*   `axialToPixel(coord: Coordinate, size: number): { x: number; y: number }`: 軸座標をピクセル座標に変換します。
*   `getNeighbors(coord: Coordinate): Coordinate[]`: 指定された座標の隣接ヘックス座標を返します。
*   `getDistance(a: Coordinate, b: Coordinate): number`: 2つのヘックス間の距離を計算します。
*   `generateBoardLayout(): BoardLayout`: ランダムな地形（平地、森、山、川、都市、道路、橋、泥濘）を含むゲームボードのレイアウトを生成します。
*   `calculateReachableTiles(start: Coordinate, movement: number, board: BoardLayout, units: Unit[], currentTeam: Team): Coordinate[]`: 指定されたユニットの移動力に基づいて、到達可能なヘックスのリストを計算します。ゾーン・オブ・コントロール (ZOC) の影響も考慮されます。

#### 4.2. 戦闘処理 (`services/battleReport.ts`, `App.tsx`)
*   `generateBattleReport(attacker: Unit, defender: Unit, terrain: TerrainType, damage: number): Promise<string>` (`services/battleReport.ts`): 攻撃側ユニット、防御側ユニット、地形、ダメージ量に基づいて、物語形式の戦闘レポートテキストを生成します。APIを使用せず、内部ロジックでレポートを作成します。
*   `handleAttack` (`App.tsx`): 攻撃力と防御力の計算（地形ボーナス、ユニットタイプごとの特攻/特防、砲兵の間接射撃による地形防御無視を含む）、ダメージ適用、ユニットのHP更新、破壊されたユニットの除去、反撃処理、そして最終的な勝利条件のチェックを行います。

### 5. UIコンポーネント

*   `App.tsx`: アプリケーションのルートコンポーネントであり、ゲームの状態管理、主要なゲームロジック、および他のUIコンポーネントの統合を行います。
*   `BattleReportModal.tsx`: `BattleReport`型のデータを受け取り、戦闘結果をモーダルウィンドウとして表示します。閉じるボタンでモーダルを閉じることができます。
*   `GameBoard.tsx`: `BoardLayout`と`Unit`のデータを受け取り、ヘックスベースのゲームボードとユニットを描画します。ヘックスのクリック/ホバーイベント、選択中のユニットの移動可能範囲/攻撃可能範囲のハイライト表示、天候エフェクト（雨）を処理します。
*   `Header.tsx`: 現在のターン数、アクティブチーム、各チームの残りユニット数、選択中のユニット情報、カーソル下のヘックス座標、現在の天候を表示します。「End Turn」ボタンを提供します。
*   `Hexagon.tsx`: `Coordinate`, `TerrainType`, `size`などのプロパティを受け取り、単一のヘックスタイルを描画します。地形の色分け、到達可能/攻撃可能/選択中のヘックスのハイライト表示を行います。
*   `Icons.tsx`: `UnitType`と`Team`を受け取り、各ユニットタイプに対応するSVGアイコンを描画します。チームカラーが適用されます。
*   `InfoPanel.tsx`: ホバー中のヘックス/ユニット情報、ゲームの状態（ゲームオーバー時）、勝利チーム、ゲーム再開ボタン、選択中のユニットに対するアクション（待機、移動の取り消し）を表示します。