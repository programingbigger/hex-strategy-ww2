# 遠距離攻撃ユニット定義書

## 1. ユニットタイプ名
- **Artillery (砲兵)**: 後方から敵を攻撃する重火器ユニット。

## 2. 特徴
- **攻撃範囲 (Attack Range)**:
    - 最小射程: 2ヘックス
    - 最大射程: 5ヘックス
    - 隣接するヘックスのユニットには攻撃できない。
- **移動力 (Movement)**: 低い (例: 2ヘックス)
- **HP (Health Points)**: 中程度
- **攻撃力 (Attack)**: 高い
- **防御力 (Defense)**: 低い (特に近接攻撃に対して脆弱)
- **特殊能力**:
    - **間接射撃**: 攻撃対象の地形による防御ボーナスを無視する。
    - **反撃不可**: 攻撃を受けても反撃しない。
    - **限定的被ダメージ**: 敵軍からの直接攻撃（1マス）または遠距離攻撃（攻撃ユニットの最小射程が1より大きい場合）によってのみダメージを受ける。

## 3. ゲームプレイへの影響
- 敵の防御線を突破しにくいユニットや、密集した敵ユニットに対して有効な支援攻撃を提供する。
- 前線に配置すると脆弱であるため、他のユニットによる保護が必要。
- 敵の遠距離攻撃ユニットや高速移動ユニットによる側面攻撃に注意が必要。

## 4. 実装に必要な変更点 (概要)
- `types.ts`: `Unit`インターフェースに`attackRange`プロパティを追加。
- `constants.ts`: 新しい`UnitType` (`Artillery`) とその基本ステータス、`attackRange`の定義を追加。
- `App.tsx`:
    - `calculateAttackableTiles`ロジックを修正し、`attackRange`を考慮に入れる。
    - 最小射程と最大射程のロジックを実装。
    - 間接射撃のロジック（防御ボーナス無視）を実装。
    - 反撃不可のロジックを実装。

## 5. App.tsxにおける砲兵の反撃に関する解析

`App.tsx`の`handleAttack`関数内のカウンターアタックロジックは、砲兵ユニットが反撃を行わないように明示的に設計されています。

関連するコードスニペット:
```typescript
        // Counter-attack logic
        const currentDefender = updatedUnits.find(u => u.id === defender.id);
        if (currentDefender && currentDefender.hp > 0 && currentDefender.canCounterAttack && currentDefender.type !== 'Artillery') {
            // ... カウンターアタックの処理 ...
        }
```

この`if`文の条件は、カウンターアタックが実行されるために以下のすべての条件が真である必要があることを示しています。

1.  `currentDefender`が存在し、`hp > 0`である（ユニットが最初の攻撃を生き残った）。
2.  `currentDefender.canCounterAttack`が`true`である。
3.  `currentDefender.type !== 'Artillery'`である（防御側のユニットが砲兵ユニットではない）。

`constants.ts`ファイル（`App.tsx`がインポートしている）では、`Artillery`ユニットの`UNIT_STATS`に`canCounterAttack: false`が明示的に設定されています。

したがって、現在の`App.tsx`と`constants.ts`のコードに基づくと、**砲兵ユニットは明示的に反撃ができないように設定されています。** `currentDefender.type !== 'Artillery'`という条件は、たとえ`canCounterAttack`が何らかの理由で砲兵に対して上書きされたとしても、追加の安全策として機能します。

もしユーザーが砲兵が反撃していると認識している場合、以下のいずれかの理由が考えられます。
*   **戦闘レポートの誤解釈:** 戦闘レポートに表示されるダメージが、攻撃ユニットによって与えられたものであり、砲兵からの反撃と誤解されている可能性があります。
*   **他のユニットタイプの観察:** 他のユニットタイプ（歩兵、戦車、装甲車など）は`canCounterAttack: true`であり、反撃を行います。ユーザーがこの動作を砲兵にも一般化している可能性があります。
*   **古いコード/キャッシュ:** ゲームが古いバージョンのコードを実行しているか、キャッシュの問題が発生している可能性があります。
*   **予期せぬバグ:** コードが明示的に反撃を防止しているにもかかわらず、このロジックを迂回する非常に微妙なバグがどこかに存在する可能性もゼロではありませんが、このセクションの直接的なコードレビューからは明らかではありません。

当て感として、App.tsxと、constant.tsのコードを確認すれば、できそう